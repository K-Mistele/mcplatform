---
date: 2025-09-03 08:31:57 CDT
researcher: Claude Code
git_commit: e331e3d22c8c9d3da23e1ae092a91f4edad380e1
branch: master
repository: mcplatform
topic: "Drizzle ORM Usage and Migration Commands"
tags: [research, codebase, drizzle-orm, database, migrations, postgresql]
status: complete
last_updated: 2025-09-03
last_updated_by: Claude Code
type: research
---

# Research: Drizzle ORM Usage and Migration Commands in MCPlatform

**Date**: 2025-09-03 08:31:57 CDT
**Researcher**: Claude Code
**Git Commit**: e331e3d22c8c9d3da23e1ae092a91f4edad380e1
**Branch**: master
**Repository**: mcplatform

## Research Question

How is Drizzle ORM used in the MCPlatform codebase, including what commands are needed to generate and run migrations, and what other important patterns should be understood?

## Summary

MCPlatform uses Drizzle ORM with PostgreSQL in a sophisticated triple-schema architecture: platform authentication (customer users), sub-tenant OAuth (end-users), and business logic (MCP servers, walkthroughs, analytics). The system uses SST for infrastructure, Bun for runtime, and follows strict patterns for ID generation, timestamps, and multi-tenancy. Critical migration commands require explicit user permission before execution.

## Detailed Findings

### Database Architecture

#### Triple Schema Design
- **Platform Authentication Schema** (`packages/database/src/auth-schema.ts:3-105`) - Customer authentication tables generated by Better Auth
- **Sub-tenant OAuth Schema** (`packages/database/src/mcp-auth-schema.ts:3-73`) - End-user OAuth tables with parallel structure  
- **Business Logic Schema** (`packages/database/src/schema.ts:43-445`) - Core application tables for MCP servers, walkthroughs, analytics

#### Connection Setup
- **Database Connection** (`packages/database/index.ts:14-16`) - Uses Drizzle with node-postgres driver and SST Resource.Postgres
- **Schema Unification** (`packages/database/index.ts:8-12`) - All schemas merged into single export for unified access
- **Configuration** (`packages/database/drizzle.config.ts:8-15`) - Multi-schema migration support with PostgreSQL dialect

### Critical Migration Commands

#### Generation and Execution (REQUIRES USER PERMISSION)
```bash
# Generate migrations from schema changes
cd packages/database && bun run db:generate
# OR from root: bun run db:generate

# Apply migrations to database  
cd packages/database && bun run db:migrate
# OR from root: bun run db:migrate

# Better Auth schema migrations
cd packages/database && bun run db:auth:migrate
```

#### Development Tools
```bash
# Launch Drizzle Studio (database GUI)
cd packages/database && bun run db:studio
# OR from root: bun run studio

# Push schema directly (development only)
cd packages/database && bun run db:push
# OR from root: bun run db:push

# Pull current database schema
cd packages/database && bun run db:pull
```

### Core Patterns and Conventions

#### ID Generation Strategy
- **Consistent nanoid Usage** (`packages/database/src/schema.ts:64,120,147`) - Prefixed IDs: `sr_${nanoid(8)}`, `tc_${nanoid(8)}`
- **Variable Lengths** - 8 chars for most entities, 12 for users, 16 for content chunks and images
- **Import Pattern** (`packages/database/src/schema.ts:1`) - Uses `common/nanoid` workspace package

#### Timestamp Handling
- **Platform Auth** (`packages/database/src/auth-schema.ts:11-16`) - Uses `timestamp` type for Better Auth compatibility
- **Business Logic** (`packages/database/src/schema.ts:65`) - Uses `bigint` mode with `Date.now()` defaults for consistency

#### Multi-tenancy Security Pattern
- **Organization Scoping** (`packages/dashboard/src/lib/orpc/actions/organization.ts:44`) - All queries filtered by `session.session.activeOrganizationId`
- **VHost Routing** (`packages/database/src/schema.ts:120`) - Critical `slug` field enables subdomain-based MCP server routing
- **Cascade Deletes** (`packages/database/src/schema.ts:74,77,92`) - Foreign keys with `{ onDelete: 'cascade' }` for data integrity

### Query Patterns and Usage

#### Basic CRUD with Relationships
- **Select with Joins** (`packages/dashboard/src/lib/orpc/actions/organization.ts:29-46`) - Inner joins between member and user tables with organization scoping
- **Insert with Returning** (`packages/dashboard/src/lib/orpc/actions/organization.ts:279-291`) - Create invitations with immediate record return
- **Complex Updates** (`packages/dashboard/src/lib/orpc/actions/mcp-servers.ts:98-110`) - Multi-field updates with authorization checks

#### Advanced Patterns
- **Transaction Usage** (`packages/retrieval/src/inngest/functions/ingest-document.ts:139-151`) - Atomic operations with job tracking
- **Analytics Queries** (`packages/dashboard/src/lib/orpc/router.ts:61-77`) - Time-series aggregation with left joins
- **Server Component Integration** (`packages/dashboard/src/app/dashboard/page.tsx:10-22`) - Promise-based data fetching for Next.js

#### Index and Performance Patterns
- **Compound Indexes** (`packages/database/src/schema.ts:315`) - Analytics patterns like `wtsc_server_time_idx`
- **GIN Indexes** (`packages/database/src/schema.ts:285`) - JSONB field indexing for completed steps
- **Unique Constraints** (`packages/database/src/schema.ts:135`) - Distinct option for nullable unique fields

### Environment and Configuration

#### SST Integration
- **Resource Management** (`packages/database/drizzle.config.ts:7`) - Dynamic database credentials from SST
- **Connection String** (`packages/database/index.ts:15`) - Constructed from SST Resource.Postgres properties
- **Type Definitions** (`packages/database/sst-env.d.ts:6`) - SST environment type support

#### Development Environment
- **Bun Runtime** - All commands use `bun run` instead of npm/yarn
- **Environment Loading** (`packages/database/drizzle.config.ts:1`) - Automatic `.env` loading via `dotenv/config`
- **TypeScript Support** - Full type inference with `$inferSelect` patterns

### Migration Infrastructure

#### Migration Tracking
- **Journal System** (`packages/database/migrations/meta/_journal.json:4-33`) - Tracks 4 migrations with version 7 format
- **Migration Files** - Sequential SQL files: `0000_first_skreet.sql` through `0003_fresh_blacklash.sql`
- **Programmatic Execution** (`packages/database/migrator.ts:4-10`) - Handler function for automated migration runs

#### Better Auth Integration
- **Dual Schema Generation** - Separate Better Auth CLI commands for auth schema updates
- **Plugin Support** (`packages/database/src/auth-schema.ts:98-105`) - Organization plugin with multi-tenancy
- **OAuth Configuration** (`packages/database/src/mcp-auth-schema.ts:60-73`) - OAuth application management tables

## Code References

- `packages/database/index.ts:16` - Main database connection with unified schema
- `packages/database/src/schema.ts:120` - Critical `mcpServers` table with slug field for vhost routing
- `packages/database/drizzle.config.ts:10` - Multi-schema configuration for migrations
- `packages/database/src/auth-schema.ts:98-105` - Organization plugin tables for multi-tenancy
- `packages/database/src/mcp-auth-schema.ts:3-73` - Sub-tenant OAuth schema for end-user auth
- `packages/dashboard/src/lib/orpc/actions/organization.ts:29-46` - Example query with joins and organization scoping
- `packages/database/migrations/meta/_journal.json:4-33` - Migration tracking with 4 applied migrations

## Architecture Insights

### Dual Authentication Strategy
The platform implements two completely separate authentication systems to maintain clean separation between customers (who use the dashboard) and their end-users (who interact with MCP servers). This enables powerful de-anonymization capabilities while maintaining security boundaries.

### VHost-Based MCP Routing
Critical business logic depends on the `slug` field in `mcpServers` table. When requests arrive at the API, the `Host` header is parsed to extract the subdomain, which matches against the `slug` to determine which MCP server configuration to load. This enables infinite MCP servers on a single API endpoint.

### Schema Versioning Strategy
- Manual business logic schemas in `schema.ts`
- Auto-generated auth schemas from Better Auth CLI
- Coordinated migration strategy across all three schema files
- Version 7 Drizzle format with breakpoints enabled for rollback support

### Type Safety and Developer Experience
- Full TypeScript integration with schema inference
- Unified schema export for consistent imports
- Structured error handling through oRPC error types
- Bun-optimized runtime with automatic environment loading

## Historical Context (from specifications/)

### Database Design Decisions
- `specifications/02-ticket-management/01-core-management/implementation-plan.md` - Established workflow: "All schema changes will be made by updating Drizzle ORM TypeScript schemas, then requesting migration generation and execution"
- `specifications/06-documentation-retrieval-ui/thoughts/ui-decisions-and-requirements.md` - Decision to use generated columns in schema.ts and rely on Drizzle for SQL injection protection
- `specifications/04-user-management/handoffs/handoff_2025-08-25_21-00-21_invitation-flow-fix.md` - Established requirement for explicit user permission before database migrations

### Authentication Architecture Evolution
- `specifications/04-user-management/research/research_2025-08-25_15-58-23_auth-implementation.md` - Research establishing separate schema design with `mcp_` prefixed tables
- `specifications/04-user-management/thoughts/better_auth_organization_with_invite.md` - Better Auth organization plugin documentation with multi-tenancy considerations

### Migration Strategy Development
- `specifications/03-interactive-walkthrough/03-server-assignment-ui/implementation-plan.md` - Early mention of using Drizzle Kit for display ordering migrations
- Multiple handoffs reference the importance of explicit migration permission due to production safety concerns

## Open Questions

1. **Migration Rollback Strategy**: While migrations have breakpoints enabled, the codebase doesn't show rollback procedures
2. **Development vs Production**: The relationship between `db:push` (development) and `db:migrate` (production) workflows could be clarified
3. **Better Auth Schema Sync**: How changes to Better Auth plugin configurations affect the auto-generated schemas
4. **Performance Monitoring**: No observability patterns found for slow queries or connection pool monitoring

## Related Research

- Historical context found in 14 thought documents covering authentication architecture, migration strategies, and schema design decisions
- Implementation plans in specifications/ directory show evolution of database architecture over time
- Handoff documents emphasize safety requirements around migration execution